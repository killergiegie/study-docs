# <center>å†…å­˜ä¸æ•°æ®æ’åˆ—</center>

## 1. æ•°æ®è¡¨ç¤ºæ–¹æ³•

### 1.1 Tensorçš„ shape ä¸ stride
Tensor æ˜¯ä¸€ä¸ª4ç»´æ•°ç»„ï¼Œä½¿ç”¨4å…ƒç»„(N,C,H,W)æ¥æè¿°ä¸€ä¸ªTensorçš„å‡ ä½•å°ºå¯¸ï¼ˆ Shape ï¼‰ã€‚ Tensor(n, c, h, w)è¡¨ç¤ºåœ¨ï¼ˆn,c,h,wï¼‰ç´¢å¼•ä¸‹çš„æ•°æ®å…ƒç´ ã€‚
Stride ç”¨äºæè¿°Tensoråœ¨å®é™…å†…å­˜å½“ä¸­æ˜¯å¦‚ä½•æ‘†æ”¾ï¼ŒåŒæ ·ä½¿ç”¨4å…ƒç»„ï¼ˆN_strideï¼ŒC_strideï¼ŒH_strideï¼ŒW_strideï¼‰æ¥æè¿°ï¼Œ è¡¨ç¤º Tensor åœ¨å†…å­˜å½“ä¸­å­˜æ”¾æ—¶ï¼Œå…ƒç´ é—´é—´éš”äº†å¤šå°‘å…ƒç´ ï¼Œå…·ä½“è€Œè¨€ï¼š
- W_stride æè¿°çš„æ˜¯ä»Tensorï¼ˆn,c,h,wï¼‰åˆ°Tensorï¼ˆn,c,h,w+1ï¼‰ä¸¤ä¸ªå…ƒç´ ä¹‹é—´ï¼Œåœ¨å†…å­˜å­˜å‚¨æ—¶ï¼Œé—´éš”äº†å¤šå°‘ä¸ªå…ƒç´ ã€‚
- H_stride æè¿°çš„æ˜¯ä»Tensorï¼ˆn,c,h,wï¼‰åˆ°Tensorï¼ˆn,c,h+1,wï¼‰ä¸¤ä¸ªå…ƒç´ ä¹‹é—´ï¼Œåœ¨å†…å­˜å­˜å‚¨æ—¶ï¼Œé—´éš”äº†å¤šå°‘ä¸ªå…ƒç´ ã€‚
- C_stride æè¿°çš„æ˜¯ä»Tensorï¼ˆn,c,h,wï¼‰åˆ°Tensorï¼ˆn,c+X,h,wï¼‰ä¸¤ä¸ªå…ƒç´ ä¹‹é—´ï¼Œåœ¨å†…å­˜å­˜å‚¨æ—¶ï¼Œé—´éš”äº†å¤šå°‘ä¸ªå…ƒç´ ï¼ŒXè¡¨ç¤ºNPUçš„æ•°é‡ã€‚
- N_stride æè¿°çš„æ˜¯ä»Tensorï¼ˆn,c,h,wï¼‰åˆ°Tensorï¼ˆn+1,c,h,wï¼‰ä¸¤ä¸ªå…ƒç´ ä¹‹é—´ï¼Œåœ¨å†…å­˜å­˜å‚¨æ—¶ï¼Œé—´éš”äº†å¤šå°‘ä¸ªå…ƒç´ ã€‚

> **ä»€ä¹ˆæ˜¯Tensor(n, c, h, w)ï¼Ÿ**
Tensorï¼šæ˜¯ä¸€ä¸ª 4 ç»´æ•°ç»„ï¼Œç”¨ 4 å…ƒç»„ (N, C, H, W) è¡¨ç¤ºï¼š
Nï¼šBatch å¤§å°ï¼ˆæ ·æœ¬æ•°ï¼‰
Cï¼šé€šé“æ•°ï¼ˆæ¯”å¦‚å›¾åƒçš„RGBå°±æœ‰3ä¸ªé€šé“ï¼‰
Hï¼šé«˜åº¦ï¼ˆå›¾åƒè¡Œæ•°ï¼‰
Wï¼šå®½åº¦ï¼ˆå›¾åƒåˆ—æ•°ï¼‰
Strideï¼ˆæ­¥é•¿ï¼‰ï¼šæè¿° å†…å­˜ä¸­ç›¸é‚»å…ƒç´ ä¹‹é—´çš„è·ç¦»ï¼ˆåç§»é‡ï¼‰ï¼Œä»¥å…ƒç´ ä¸ªæ•°ä¸ºå•ä½ï¼ˆè€Œä¸æ˜¯å­—èŠ‚ï¼‰ã€‚

>**ä»€ä¹ˆæ˜¯ Batch æ ·æœ¬ (N)ï¼Ÿ**
Batch æ˜¯æ·±åº¦å­¦ä¹ ä¸­ç”¨äº ä¸€æ¬¡æ€§å¹¶è¡Œå¤„ç†å¤šä¸ªæ ·æœ¬ çš„ä¸€ç§æŠ€æœ¯ã€‚
ä¾‹å¦‚ï¼Œå¦‚æœä½ è¦è®©æ¨¡å‹ä¸€æ¬¡å¤„ç† 32 å¼ å›¾ç‰‡ï¼Œé‚£ä¹ˆ N=32ï¼Œå³ batch size=32ã€‚
è¿™æ ·å¯ä»¥å……åˆ†åˆ©ç”¨ç¡¬ä»¶èµ„æºï¼ˆæ¯”å¦‚ TPU/GPUï¼‰ï¼Œæé«˜è®¡ç®—æ•ˆç‡å’Œååé‡ã€‚
ğŸ’¡ åœ¨å¼ é‡ Tensor(N,C,H,W) ä¸­ï¼š
N è¡¨ç¤ºæ‰¹å¤§å° (batch size)ï¼Œä¹Ÿå°±æ˜¯æœ‰å¤šå°‘ä¸ªæ ·æœ¬ï¼ˆå›¾ç‰‡/éŸ³é¢‘/æ–‡æœ¬ç‰‡æ®µï¼‰ä¸€èµ·å¤„ç†ã€‚
æ¯”å¦‚ï¼š(32,3,224,224) è¡¨ç¤ºä¸€æ¬¡å¤„ç† 32 å¼  RGBï¼ˆ3é€šé“ï¼‰224x224 åƒç´ çš„å›¾ç‰‡ã€‚

>**ä»€ä¹ˆæ˜¯ é€šé“ (C)ï¼Ÿ**
C æ˜¯ Channelï¼ˆé€šé“ï¼‰ï¼ŒæŒ‡æ¯ä¸ªæ ·æœ¬çš„æ•°æ®ç»´åº¦ã€‚
å¯¹äºå›¾åƒï¼š
å½©è‰²å›¾ï¼ˆRGBï¼‰æœ‰ 3 ä¸ªé€šé“ï¼ˆR,G,Bï¼‰ï¼Œæ‰€ä»¥ C=3ã€‚
é»‘ç™½å›¾ï¼ˆç°åº¦å›¾ï¼‰åªæœ‰ 1 ä¸ªé€šé“ï¼ˆC=1ï¼‰ã€‚
å¯¹äºå…¶ä»–æ•°æ®ï¼ˆæ¯”å¦‚è¯­éŸ³ã€æ–‡æœ¬ï¼‰ï¼ŒC è¡¨ç¤ºç‰¹å¾ç»´åº¦ï¼Œæ¯”å¦‚æ¯å¸§éŸ³é¢‘çš„é¢‘è°±ç»´åº¦ã€æ¯ä¸ªæ—¶é—´æ­¥çš„ embedding ç»´åº¦ã€‚

å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªTensorï¼Œå®ƒçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½å 1ä¸ªbyteï¼Œå®ƒçš„Shapeæ˜¯ï¼ˆ4ï¼Œ3ï¼Œ2ï¼Œ2ï¼‰ï¼Œ å¦‚æœå®ƒçš„å­˜å‚¨æ–¹å¼Strideæ˜¯ï¼ˆ12ï¼Œ4ï¼Œ2ï¼Œ1ï¼‰ï¼Œåœ¨å†…å­˜å½“ä¸­ï¼Œå®ƒçš„æ’åˆ—æ–¹å¼å°±ä¼šå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ
![alt text](./img/tensor_example01.png)
![alt text](./img/tensor_example01.jpg)

å¦‚æœTensorçš„å­˜å‚¨æ–¹å¼Strideæ˜¯ï¼ˆ24ï¼Œ8ï¼Œ4ï¼Œ2ï¼‰ï¼Œåœ¨å†…å­˜å½“ä¸­ï¼ŒTensorçš„æ’åˆ—æ–¹å¼å°±ä¼šå¦‚ä¸‹æ‰€ç¤ºï¼Œ
![alt text](./img/tensor_example02.png)
![alt text](./img/tensor_example02.jpg)

### 1.2 æ•°æ®å…ƒç´ ç±»å‹
Stride ä»¥å…ƒç´ ä¸ªæ•°ä½œä¸ºè®¡é‡å•ä½ã€‚ä¸åŒç±»å‹çš„æ•°æ®å…ƒç´ å æ®ä¸åŒçš„å­—èŠ‚æ•°ï¼Œ åœ¨BM1684xèŠ¯ç‰‡ä¸Šæ”¯æŒå¦‚ä¸‹æ ¼å¼çš„æ•°æ®ç±»å‹:
| æ•°æ®ç±»å‹ | å­—èŠ‚æ•° |
| -------- | ------ |
| INT8     | 1Bytes |
| INT16    | 2Bytes |
| INT32    | 4Bytes |
| FP16     | 2Bytes |
| BFP16    | 2Bytes |
| FP32     | 4Bytes |

## 2. Tensoråœ¨gloabl memoryçš„æ’åˆ—æ–¹å¼
global memory ç”±ä¸€å— **DDR å†…å­˜**ç»„æˆã€‚
ä¸€ä¸ªShapeä¸ºï¼ˆNï¼ŒCï¼ŒHï¼ŒWï¼‰çš„Tensorï¼Œåœ¨ global memory æ’åˆ—ï¼Œå¯¹åº”çš„Strideä¸º:
- W_Stride = 1,
- H_Stride = W,
- C_Stride = H * W,
- N_Stride = C * H * Wã€‚

è¿™ç§æ’åˆ—æ–¹å¼è¢«ç§°ä¸º è¿ç»­å­˜å‚¨æ–¹å¼ ã€‚

*ä¸¾ä¾‹ï¼š ä¸€ä¸ªShapeï¼ˆN=2ï¼ŒC=2ï¼ŒH=3ï¼ŒW=2ï¼‰çš„Tensoråœ¨global memoryæ’åˆ—æ–¹å¼*

![alt text](./img/tensor_example03.png)

## 3. Tensoråœ¨local memoryçš„æ’åˆ—æ–¹å¼

### 3.1 local memoryçš„ç‰©ç†ç»„æˆå’Œåœ°å€åˆ†é…
Local Memoryå…±ç”±å¤šç‰‡SRAMï¼ˆé™æ€éšæœºå­˜å–å­˜å‚¨å™¨ï¼‰æ„æˆï¼Œæ¯ä¸€ç‰‡SRAMéƒ½è¢«ç§°ä¸ºä¸€ä¸ª Bankã€‚
bm1684xèŠ¯ç‰‡ä¸€å…±ç”±16ä¸ªBankæ„æˆã€‚16ä¸ªBankç»„æˆæ•´ä¸ª local memoryã€‚
æ•´ä¸ªLocal MemoryåŒæ—¶è¢«åˆ’åˆ†ä¸ºäº†64ä¸ª lane (å¯¹åº”64ä¸ªNPUï¼Œä»¥ä¸‹ç”¨NPUæŒ‡ä»£lane)ï¼Œåœ°å€åˆ†é…å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![alt text](./img/local_mem.png)

>BM1684x çš„ Local Memory ç”±16ä¸ªç‹¬ç«‹çš„1MB SRAMï¼ˆBankï¼‰ç»„æˆï¼Œæ€»å®¹é‡16MBã€‚é€»è¾‘ä¸Šï¼ŒLocal Memory è¢«åˆ’åˆ†ä¸º64æ®µï¼Œæ¯æ®µ256KBï¼Œåˆ†åˆ«åˆ†é…ç»™64ä¸ª NPUï¼Œæ¯ä¸ª NPU çš„åœ°å€ç©ºé—´æ˜¯è¿ç»­çš„256KBã€‚ç¡¬ä»¶é€šè¿‡åœ°å€æ˜ å°„ï¼Œå°†æ¯ä¸ª NPU çš„é€»è¾‘åœ°å€ç©ºé—´åˆ†æ•£å­˜å‚¨åœ¨16ä¸ªç‰©ç† Bank ä¸­ï¼Œä»è€Œå®ç°é«˜æ•ˆçš„å¹¶è¡Œè®¿é—®ä¸å¸¦å®½åˆ©ç”¨ã€‚

>**ä¸ºä»€ä¹ˆä¸æŒ‰ã€Œ4ä¸ªNPUä¸€ä¸ªBankã€åˆ’åˆ†ï¼Ÿ**
æé«˜ å†…å­˜è®¿é—®å¸¦å®½ å’Œ å¹¶è¡Œè®¿é—®æ•ˆç‡
TPU çš„æ¯ä¸ª NPUï¼ˆlaneï¼‰éœ€è¦åŒæ—¶è®¿é—®è‡ªå·±çš„å±€éƒ¨æ•°æ®ï¼ˆlocal memoryï¼‰ã€‚
å¦‚æœ 4 ä¸ª NPU å…±ç”¨ä¸€ä¸ª Bankï¼Œé‚£ä¹ˆå®ƒä»¬è®¿é—®å†…å­˜æ—¶å°±ä¼šã€ŒæŠ¢åŒä¸€ä¸ªæŸœå­ã€ï¼Œä¼šäº§ç”Ÿ è®¿é—®å†²çªï¼ˆBank Conflictï¼‰ï¼Œé™ä½è®¿é—®å¸¦å®½ã€‚
æŠŠæ•°æ®åœ°å€æŒ‰ NPU åˆ†åŒºï¼Œæ‰“æ•£åˆ°å¤šä¸ª Bankï¼Œè®©æ¯ä¸ª NPU èƒ½ç‹¬ç«‹è®¿é—®ä¸åŒçš„ç‰©ç† Bankï¼Œè¿™æ ·å¯ä»¥ å¹¶è¡Œå¤„ç†æ›´å¤šä»»åŠ¡ï¼Œå¤§å¤§æé«˜æ•´ä½“æ€§èƒ½ã€‚
ğŸ’¡ ç±»æ¯”ï¼šå¦‚æœå¤§å®¶éƒ½å»åŒä¸€ä¸ªæŸœå­ï¼ˆBankï¼‰å–ä¸œè¥¿ï¼Œä¼šæ’é˜Ÿï¼›ä½†å¦‚æœå¤§å®¶æœ‰ç‹¬ç«‹çš„æŸœå­ï¼ˆæˆ–ç³»ç»Ÿè‡ªåŠ¨å¸®ä½ åˆ†æ•£å­˜å–ï¼‰ï¼Œå°±å¯ä»¥åŒæ—¶è¿›è¡Œã€‚

### 3.2 Tensoråœ¨Local memoryä¸Šæ’åˆ—çš„åŸºæœ¬è§„åˆ™
Tensoråœ¨Local Memoryä¸Šçš„æ’å¸ƒæ–¹å¼ä¸global Memoryçš„æ’å¸ƒæ–¹å¼ä¸åŒï¼Œä¸»è¦åŒºåˆ«åœ¨äº Cç»´åº¦çš„æ•°æ®æ’å¸ƒæ–¹å¼ã€‚ ä¸€ä¸ªShapeä¸ºï¼ˆNï¼ŒCï¼ŒHï¼ŒWï¼‰çš„Tensorï¼ŒTensorï¼ˆN,c,H,Wï¼‰ä»£è¡¨ï¼šå½“C = cæ—¶ï¼ŒTensorçš„æ•°æ®åˆ‡ç‰‡ã€‚ å¯¹äºä¸åŒçš„cï¼Œ Tensorï¼ˆNï¼Œcï¼ŒHï¼ŒWï¼‰åˆ†é…åœ¨ä¸åŒçš„NPUä¸Šã€‚

*ä¸¾ä¾‹ï¼ŒTensorçš„Shapeï¼ˆN=2,C=3,H=2,W=3ï¼‰,Strideï¼ˆN_stride = 9ï¼ŒC_stride = 9, H_stride = 3, W_stride = 1ï¼‰ é‚£ä¹ˆTensoråœ¨Local Memoryä¸Šçš„æ•°æ®æ’åˆ—æ–¹å¼å¦‚ä¸‹æ‰€ç¤ºã€‚*

![alt text](./img/local_mem_hw_arrange.png)

### 3.3 Local Memoryä¸Šå‡ ç§å¸¸ç”¨æ•°æ®æ’å¸ƒæ–¹å¼
#### 3.3.1 64-Byteså¯¹é½å­˜å‚¨æ–¹å¼
64-Byteså¯¹é½å­˜å‚¨æ–¹å¼â€æ˜¯æœ€å¸¸ç”¨çš„Tensorå­˜å‚¨æ–¹å¼ï¼Œå®ƒæ˜¯æŒ‡Tensoræ’æ”¾å­˜å‚¨è¦æ»¡è¶³ä»¥ä¸‹å‡ ä¸ªçº¦æŸï¼š
Tensorçš„èµ·å§‹åœ°å€æ˜¯64çš„æ•´æ•°å€
- W_stride = 1
- H_stride = W
- C_stride = ceil(H * W, 16) * 16, è‹¥æ•°æ®å…ƒç´ æ˜¯32-bits
  C_stride = ceil(H * W, 32) * 32, è‹¥æ•°æ®å…ƒç´ æ˜¯16-bits
  C_stride = ceil(H * W, 64) * 64, è‹¥æ•°æ®å…ƒç´ æ˜¯ 8-bits
- N_stride = C_stride * (å•ä¸ªNPUä¸Šchannelçš„ä¸ªæ•°)

å…¶ä¸­ ceil æ˜¯å‘ä¸Šå–æ•´çš„æ„æ€ã€‚å¯é€šè¿‡ ```tpu_aligned_stride()``` è®¡ç®— strideã€‚

**å‡è®¾NPUä¸ªæ•°=4**
*ä¸¾ä¾‹1: Tensorçš„Shape(.N=2,.C=3,.H=4,.W=5),æ•°æ®ç±»å‹ä¸ºfloat16ï¼Œ NPU0å¼€å§‹å­˜å‚¨*

> åˆ†æè¿‡ç¨‹ï¼š
> - float16 å³ 16-bitsæ•°æ®ï¼Œ2Bæ•°æ®
> - 64Bå¯¹é½ä»£è¡¨ (64B / 2B) å³ 32 ä¸ªå…ƒç´ å¯¹é½ï¼Œæ•…
> - W_stride = 1
> - H_stride = W = 5
> - C_stride = ceil(20,32)*32 = 32å…ƒç´ 
> - N_stride = C_stride * 1 = 32 * 1 = 32


![alt text](./img/align_fp32_start_0_2_3_4_5.png)

*ä¸¾ä¾‹2: Tensorçš„Shape(.N=2,.C=3,.H=4,.W=5),æ•°æ®ç±»å‹ä¸ºfloat16ï¼ŒNPU2å¼€å§‹å­˜å‚¨*

> - åˆ†æè¿‡ç¨‹ï¼š
>   ç”±äºä» NPU2 å¼€å§‹å­˜å‚¨ï¼Œå› å¯¹é½æ‰€ä»¥éœ€è¦æ¯ä¸ªNPUå¤„ç†ä¸¤ä¸ªchannel

![alt text](./img/align_fp32_start_2_2_3_4_5.png)

#### 3.3.2 ç´§å‡‘å­˜å‚¨æ–¹å¼
â€œç´§å‡‘å­˜å‚¨æ–¹å¼â€ä¹Ÿæ˜¯è¾ƒä¸ºå¸¸ç”¨çš„Tensorå­˜å‚¨æ–¹å¼ã€‚
å‡è®¾Tensorçš„Shapeä¸º(Nï¼ŒCï¼ŒHï¼ŒW)ï¼ŒæŒ‰ç…§â€œç´§å‡‘å­˜å‚¨æ–¹å¼å­˜å‚¨â€è¦æ»¡è¶³ä»¥ä¸‹çº¦æŸï¼š
- Tensorçš„èµ·å§‹åœ°å€æ˜¯4çš„æ•´æ•°å€ã€‚
- W_stride = 1
- H_stride = W
- C_stride = H * W
- N_stride = C_stride * (å•ä¸ªNPUä¸Šchannelçš„ä¸ªæ•°)

å¯é€šè¿‡``` tpu_compact_stride() ``` è®¡ç®— strideã€‚

*ä¸¾ä¾‹1: Tensorçš„Shape(.N=2,.C=3,.H=4,.W=5),æ•°æ®ç±»å‹ä¸ºfloat16ï¼Œ NPU0å¼€å§‹å­˜å‚¨*

>- åˆ†æè¿‡ç¨‹ï¼š
>  W_stride = 1
>  H_stride = W = 5
>  C_stride = W * H = 20
>  N_stride = C_stride * Channel = 20 * 1 = 20

![alt text](./img/compact_fp32_start_0_2_3_4_5.png)

*ä¸¾ä¾‹2: Tensorçš„Shape(.N=2,.C=3,.H=4,.W=5),æ•°æ®ç±»å‹ä¸ºfloat16ï¼ŒNPU2å¼€å§‹å­˜å‚¨*

>- åˆ†æè¿‡ç¨‹ï¼š
>  N_stride = 20 * 2 = 40

![alt text](./img/compact_fp32_start_2_2_3_4_5.png)

#### 3.3.3 çŸ©é˜µå­˜å‚¨æ–¹å¼
â€œçŸ©é˜µå­˜å‚¨æ–¹å¼â€æ˜¯ çŸ©é˜µè¿ç®—æŒ‡ä»¤ ç”¨çš„æ•°æ®å­˜å‚¨æ–¹å¼ã€‚

å¯¹äºä¸€ä¸ªn x mçš„çŸ©é˜µï¼Œå¯ä»¥ç”¨Tensorçš„4ç»´æ•°ç»„çš„å½¢å¼æ¥è¿›è¡Œè¡¨ç¤ºï¼Œ è¿™ä¸ªTensorçš„Shapeä¸º(N=n,C=ceil(m/w),H=1,W=w),å…¶ä¸­wå¯ä»¥ä¸º(1ï¼Œm)ä¹‹é—´çš„ä»»æ„å€¼ã€‚

>**å¦‚ä½•ç”¨Tensorè¡¨ç¤ºä¸€ä¸ªçŸ©é˜µå‘¢ï¼Ÿ**
>å¯¹äºä¸€ä¸ª nÃ—m çš„çŸ©é˜µï¼ˆnè¡Œã€måˆ—ï¼‰ï¼Œå¯ä»¥ç”¨ Tensorï¼ˆ4ç»´æ•°ç»„ï¼‰çš„å½¢å¼è¡¨ç¤ºï¼Œå…¶ä¸­ï¼š
>- Shape = (N=n, C=ceil(m/w), H=1, W=w)
>- è¿™é‡Œ w æ˜¯ä¸€ä¸ªå–å€¼åœ¨[1, m]çš„å‚æ•°ã€‚
>
>å¯¹åº”å…³ç³»ï¼š
>- N=nï¼šå¯¹åº”çŸ©é˜µçš„è¡Œæ•°ï¼ˆæ¯è¡Œçœ‹ä½œä¸€ä¸ªbatchæ ·æœ¬ï¼‰ã€‚
>- W=wï¼šå¯¹åº”æ¯è¡Œåˆ†å—çš„åˆ—å®½ï¼ˆå³æŠŠæ¯è¡ŒæŒ‰wåˆ—åˆ†æˆè‹¥å¹²å—ï¼‰ã€‚
>- C=ceil(m/w)ï¼šå› ä¸ºæ¯è¡Œä¸€å…±æœ‰måˆ—ï¼Œåˆ†æˆæ¯å—wåˆ—ï¼Œæ€»å…±æœ‰ ceil(m/w)å—ï¼Œæ‰€ä»¥C=ceil(m/w)ã€‚
>- H=1ï¼šæ¯å—çš„é«˜åº¦å§‹ç»ˆä¸º1ï¼ˆå› ä¸ºåŸå§‹çŸ©é˜µåªæœ‰1è¡Œï¼‰ã€‚

*ä¸¾ä¾‹1ï¼šçŸ©é˜µçš„å½¢çŠ¶ä¸º(2x40)ï¼Œæ•°æ®ç±»å‹ä¸ºfloat16ï¼Œ w = 40*

>- åˆ†æè¿‡ç¨‹ï¼š
>n = 2, m = 40, æ¯å—å–40åˆ—ï¼Œw = 40
>N = n = 2 ï¼ˆå¯¹åº”2è¡Œï¼‰
>C = ceil(40/40) = 1ï¼ˆæ¯è¡Œéœ€è¦1å—ï¼Œä¹Ÿå°±æ˜¯åˆ†ç»™1ä¸ªNPUï¼Œæ¯å—40åˆ—ï¼‰
>H = 1ï¼ˆæ¯å—é«˜åº¦å›ºå®šä¸º1ï¼‰
>W = 40ï¼ˆæ¯å—å®½åº¦4åˆ—ï¼‰
>- æ•…æœ€åçš„Tensorè¡¨è¾¾ä¸ºï¼š``` Tensor Shape = (2, 1, 1, 40) ```
>é‡‡ç”¨64-Byteså¯¹é½å­˜å‚¨æ–¹å¼ï¼ŒC_stride = ceil(W,32) * 2 = ceil(40,32) * 32 = 2 * 32 = 64

![alt text](./img/matrix_w_40.png)

*ä¸¾ä¾‹2ï¼šçŸ©é˜µçš„å½¢çŠ¶ä¸º(2x40)ï¼Œæ•°æ®ç±»å‹ä¸ºfloat16ï¼Œ w = 20*

>- æœ€åçš„Tensorè¡¨è¾¾ä¸ºï¼š``` Tensor Shape = (2, 2, 1, 20) ```
>é‡‡ç”¨64-Byteså¯¹é½å­˜å‚¨æ–¹å¼ï¼ŒC_stride = ceil(W,32) * 2 = ceil(20,32) * 32 = 1 * 32 = 32

![alt text](./img/matrix_w_20.png)

#### 3.3.4 å‘é‡å­˜å‚¨æ–¹å¼

ï¼ˆç›¸å½“äºä¸€ä¸ªè¡Œä¸º1çš„çŸ©é˜µï¼‰
å¯¹äºä¸€ä¸ª1 x mçš„å‘é‡ï¼Œå¯ä»¥ç”¨Tensorçš„4ç»´æ•°ç»„çš„å½¢å¼æ¥è¿›è¡Œè¡¨ç¤ºï¼Œ è¿™ä¸ªTensorçš„Shapeä¸º(N=1,C=ceil(m/w),H=1,W=w),å…¶ä¸­wå¯ä»¥ä¸º(1ï¼Œm)ä¹‹é—´çš„ä»»æ„å€¼ã€‚

#### 3.3.5 è¡Œ64å­—èŠ‚å¯¹é½å­˜å‚¨æ–¹å¼
ä¸€ç§ 4D å¼ é‡åœ¨ local memory ä¸­çš„å­˜å‚¨æ ¼å¼ã€‚å¼ é‡çš„ shape æ˜¯ (N, C, H, W)ï¼Œæ»¡è¶³
- åœ°å€è¢« 64 æ•´é™¤
- W-stride æ˜¯ 1
- H-stride æ˜¯ ceil(W / 16) * 16ï¼Œå¦‚æœå…ƒç´ çš„æ•°æ®ç±»å‹çš„ä½å®½æ˜¯ 32-bitï¼Œ ceil(W / 32) * 32ï¼Œå¦‚æœæ˜¯ 16-bitï¼Œceil(W / 64) * 64ï¼Œå¦‚æœæ˜¯ 8-bit
- C-stride æ˜¯ H * H-stride
- N-stride æ˜¯ C-stride ä¹˜ä»¥æ¯ä¸ª NPU çš„ channel æ•°

å¯é€šè¿‡``` tpu_line_aligned_stride() ```è®¡ç®— strideã€‚

#### 3.3.6 64IC/32IC å­˜å‚¨æ–¹å¼

64IC/32IC å­˜å‚¨æ˜¯å·ç§¯æ ¸åœ¨ local memory ä¸­çš„ç‰¹æ®Šå­˜å‚¨æ–¹å¼ï¼Œä»…ç”¨äºå·ç§¯è®¡ç®—è¿‡ç¨‹ã€‚å…¶ä¸­ INT8 kernel ä»¥ 64IC æ ¼å¼å­˜æ”¾ï¼Œ FP16/BFP16 kernel ä»¥ 32IC æ ¼å¼å­˜æ”¾ã€‚

å‡è®¾å·ç§¯æ ¸çš„ shape æ˜¯ (ic, oc, kh, kw)ï¼Œåˆ†åˆ«è¡¨ç¤º input channelã€ output channelã€ å·ç§¯æ ¸çš„é«˜åº¦ä»¥åŠå·ç§¯æ ¸çš„å®½åº¦ã€‚

64IC å­˜å‚¨æ»¡è¶³ï¼š
- W_stride = 64
- H_stride = 64 * kw
- C_stride = 64 * kw * kh * ceil(ic/64)
- N_stride = 64 * kw * kh * ceil(ic/64)

å…¶ä¸­ï¼Œæ¯ 64 ä¸ª input channel ä½œä¸ºä¸€ç»„è¿›è¡Œå­˜å‚¨ï¼Œæ¯ç»„ä¹‹é—´çš„ stride ä¸º 64 * kw * khã€‚

32IC å­˜å‚¨æ»¡è¶³ï¼š
- W_stride = 32
- H_stride = 32 * kw
- C_stride = 32 * kw * kh * ceil(ic/32)
- N_stride = 32 * kw * kh * ceil(ic/32)

å…¶ä¸­ï¼Œæ¯ 32 ä¸ª input channel ä½œä¸ºä¸€ç»„è¿›è¡Œå­˜å‚¨ï¼Œæ¯ç»„ä¹‹é—´çš„ stride ä¸º 32 * kw * khã€‚







